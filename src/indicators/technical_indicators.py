"""
ê¸°ìˆ ì  ì§€í‘œ ê³„ì‚° ëª¨ë“ˆ

ì´ë™í‰ê· ì„ , MACD, ìŠ¤í† ìºìŠ¤í‹±, OBV ë“±ì˜ ê¸°ìˆ ì  ì§€í‘œë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.

===============================================================================
[í•™ìŠµ ê°€ì´ë“œ] - ì´ íŒŒì¼ì„ ì½ê¸° ì „ì—
===============================================================================

ğŸ“š ì´ íŒŒì¼ì˜ ì—­í• :
    - ì£¼ì‹ ì°¨íŠ¸ ë¶„ì„ì— ì‚¬ìš©ë˜ëŠ” ê¸°ìˆ ì  ì§€í‘œë“¤ì„ ê³„ì‚°í•©ë‹ˆë‹¤
    - pandas/numpyë¥¼ ì‚¬ìš©í•˜ì—¬ ìˆ˜í•™ì  ê³„ì‚°ì„ íš¨ìœ¨ì ìœ¼ë¡œ ìˆ˜í–‰í•©ë‹ˆë‹¤
    - ë‹¤ë¥¸ ëª¨ë“ˆ(selector.py)ì—ì„œ ì¢…ëª© ì„ ì •ì— ì´ ì§€í‘œë“¤ì„ í™œìš©í•©ë‹ˆë‹¤

ğŸ¯ í•™ìŠµ ëª©í‘œ:
    1. pandasì˜ rolling(), ewm() ë©”ì„œë“œ ì‚¬ìš©ë²• ì´í•´í•˜ê¸°
    2. ê° ê¸°ìˆ ì  ì§€í‘œì˜ ì˜ë¯¸ì™€ íˆ¬ì í™œìš©ë²• ë°°ìš°ê¸°
    3. NumPy/Pandasë¡œ ì‹œê³„ì—´ ë°ì´í„° ì²˜ë¦¬í•˜ëŠ” ë°©ë²• ìµíˆê¸°

ğŸ“– ì‚¬ì „ ì§€ì‹:
    - ì£¼ì‹ ì°¨íŠ¸ì˜ ê¸°ë³¸ (ìº”ë“¤, ê±°ë˜ëŸ‰)
    - pandas Series/DataFrame ê¸°ë³¸ ê°œë…
    - í‰ê· , í‘œì¤€í¸ì°¨ ë“± ê¸°ì´ˆ í†µê³„

ğŸ”— ê´€ë ¨ íŒŒì¼:
    - src/stock_selector/selector.py: ì´ ì§€í‘œë“¤ì„ ì‚¬ìš©í•˜ì—¬ ì¢…ëª© ì„ ì •
    - config/config.yaml: ì§€í‘œ ì„¤ì •ê°’ (ê¸°ê°„ ë“±)

ğŸ’¡ ê¸°ìˆ ì  ì§€í‘œë€?
    ì£¼ê°€, ê±°ë˜ëŸ‰ ë“±ì˜ ê³¼ê±° ë°ì´í„°ë¥¼ ìˆ˜í•™ì ìœ¼ë¡œ ê°€ê³µí•˜ì—¬
    ë¯¸ë˜ ì£¼ê°€ ë°©í–¥ì„ ì˜ˆì¸¡í•˜ë ¤ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.

    ì˜ˆ: ì´ë™í‰ê· ì„ ì´ ìš°ìƒí–¥í•˜ë©´ ìƒìŠ¹ ì¶”ì„¸ë¡œ í•´ì„

âš ï¸ ì£¼ì˜:
    ì´ ëª¨ë“ˆì€ TA-Lib ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ 
    ìˆœìˆ˜ pandas/numpyë¡œ êµ¬í˜„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
    ì´ë ‡ê²Œ í•˜ë©´ ì˜ì¡´ì„±ì´ ì¤„ê³  ë””ë²„ê¹…ì´ ì‰¬ì›Œì§‘ë‹ˆë‹¤.

===============================================================================
"""

# ============================================================================
# [í•™ìŠµ í¬ì¸íŠ¸] ë°ì´í„° ë¶„ì„ ë¼ì´ë¸ŒëŸ¬ë¦¬
# ============================================================================
# numpy: ê³ ì„±ëŠ¥ ìˆ˜ì¹˜ ê³„ì‚° (ë°°ì—´ ì—°ì‚°, ìˆ˜í•™ í•¨ìˆ˜)
# pandas: ë°ì´í„° ë¶„ì„ (í‘œ í˜•íƒœ ë°ì´í„° ì²˜ë¦¬, ì‹œê³„ì—´ ë¶„ì„)
#
# ì„¤ì¹˜: pip install numpy pandas
#
# pandasì˜ í•µì‹¬ ìë£Œí˜•:
#   - Series: 1ì°¨ì› ë°ì´í„° (ì˜ˆ: ì¢…ê°€ ë¦¬ìŠ¤íŠ¸)
#   - DataFrame: 2ì°¨ì› í‘œ (ì˜ˆ: ë‚ ì§œë³„ ì‹œê°€/ê³ ê°€/ì €ê°€/ì¢…ê°€)
# ============================================================================
import numpy as np  # ìˆ˜ì¹˜ ê³„ì‚° ë¼ì´ë¸ŒëŸ¬ë¦¬
import pandas as pd  # ë°ì´í„° ë¶„ì„ ë¼ì´ë¸ŒëŸ¬ë¦¬
from typing import Dict, Tuple  # íƒ€ì… íŒíŠ¸


class TechnicalIndicators:
    """ê¸°ìˆ ì  ì§€í‘œ ê³„ì‚° í´ë˜ìŠ¤"""

    def __init__(self):
        """ì´ˆê¸°í™”"""
        pass

    def calculate_ma(self, data: pd.Series, period: int) -> pd.Series:
        """
        ì´ë™í‰ê· ì„  ê³„ì‚°

        Args:
            data: ê°€ê²© ë°ì´í„° (Series)
            period: ì´ë™í‰ê·  ê¸°ê°„

        Returns:
            ì´ë™í‰ê· ì„  ê°’ (Series)
        """
        # ====================================================================
        # [í•™ìŠµ í¬ì¸íŠ¸] ì´ë™í‰ê· ì„  (Moving Average, MA)
        # ====================================================================
        # íˆ¬ì ì˜ë¯¸:
        #   - ê°€ê²©ì˜ ì¶”ì„¸ë¥¼ íŒŒì•…í•˜ëŠ” ê°€ì¥ ê¸°ë³¸ì ì¸ ì§€í‘œ
        #   - ë‹¨ê¸° MA(5ì¼)ê°€ ì¥ê¸° MA(20ì¼)ë¥¼ ìƒí–¥ ëŒíŒŒí•˜ë©´ "ê³¨ë“ í¬ë¡œìŠ¤"
        #   - ê³¨ë“ í¬ë¡œìŠ¤ëŠ” ìƒìŠ¹ ì¶”ì„¸ ì‹œì‘ ì‹ í˜¸ë¡œ í•´ì„
        #
        # ê¸°ìˆ ì  êµ¬í˜„:
        #   rolling(window=period): ì´ë™ ìœˆë„ìš° ìƒì„±
        #   .mean(): ìœˆë„ìš° ë‚´ í‰ê·  ê³„ì‚°
        #
        # ì˜ˆì‹œ (period=3):
        #   ë°ì´í„°: [10, 12, 11, 13, 15]
        #   ê²°ê³¼:   [NaN, NaN, 11, 12, 13]
        #           ì²« 2ê°œëŠ” ë°ì´í„° ë¶€ì¡±ìœ¼ë¡œ NaN
        #           11 = (10+12+11)/3
        #           12 = (12+11+13)/3
        #           13 = (11+13+15)/3
        # ====================================================================
        return data.rolling(window=period).mean()

    def calculate_ema(self, data: pd.Series, period: int) -> pd.Series:
        """
        ì§€ìˆ˜ì´ë™í‰ê· ì„  ê³„ì‚°

        Args:
            data: ê°€ê²© ë°ì´í„° (Series)
            period: ì´ë™í‰ê·  ê¸°ê°„

        Returns:
            ì§€ìˆ˜ì´ë™í‰ê· ì„  ê°’ (Series)
        """
        # ====================================================================
        # [í•™ìŠµ í¬ì¸íŠ¸] ì§€ìˆ˜ì´ë™í‰ê· ì„  (Exponential Moving Average, EMA)
        # ====================================================================
        # íˆ¬ì ì˜ë¯¸:
        #   - ë‹¨ìˆœ ì´ë™í‰ê· (MA)ë³´ë‹¤ ìµœê·¼ ë°ì´í„°ì— ë” í° ê°€ì¤‘ì¹˜ë¥¼ ë¶€ì—¬
        #   - ì¶”ì„¸ ë³€í™”ì— ë” ë¹ ë¥´ê²Œ ë°˜ì‘ (ë‹¨ê¸° íŠ¸ë ˆì´ë”©ì— ìœ ë¦¬)
        #   - MACD ê³„ì‚°ì— EMAê°€ ì‚¬ìš©ë¨
        #
        # MA vs EMA:
        #   MA: ëª¨ë“  ë°ì´í„°ì— ë™ì¼í•œ ê°€ì¤‘ì¹˜ (1/n)
        #   EMA: ìµœê·¼ ë°ì´í„°ì— ë†’ì€ ê°€ì¤‘ì¹˜, ê³¼ê±°ë¡œ ê°ˆìˆ˜ë¡ ê°€ì¤‘ì¹˜ ê°ì†Œ
        #
        # ê¸°ìˆ ì  êµ¬í˜„:
        #   ewm(span=period): Exponential Weighted Moving ìœˆë„ìš° ìƒì„±
        #   span: ì§€ìˆ˜ ê°ì‡  ê³„ìˆ˜ ê²°ì • (spanì´ í´ìˆ˜ë¡ ëŠë¦¬ê²Œ ê°ì‡ )
        #   adjust=False: ì´ˆê¸°ê°’ ê³„ì‚° ë°©ì‹ (ì¼ë°˜ì ìœ¼ë¡œ False ì‚¬ìš©)
        # ====================================================================
        return data.ewm(span=period, adjust=False).mean()

    def calculate_macd(
        self,
        data: pd.Series,
        fast_period: int = 12,
        slow_period: int = 26,
        signal_period: int = 9
    ) -> Dict[str, pd.Series]:
        """
        MACD ì§€í‘œ ê³„ì‚°

        Args:
            data: ê°€ê²© ë°ì´í„° (Series)
            fast_period: ë¹ ë¥¸ EMA ê¸°ê°„ (ê¸°ë³¸: 12)
            slow_period: ëŠë¦° EMA ê¸°ê°„ (ê¸°ë³¸: 26)
            signal_period: ì‹œê·¸ë„ ë¼ì¸ ê¸°ê°„ (ê¸°ë³¸: 9)

        Returns:
            {'macd': MACD ë¼ì¸, 'signal': ì‹œê·¸ë„ ë¼ì¸, 'histogram': íˆìŠ¤í† ê·¸ë¨}
        """
        # ====================================================================
        # [í•™ìŠµ í¬ì¸íŠ¸] MACD (Moving Average Convergence Divergence)
        # ====================================================================
        # íˆ¬ì ì˜ë¯¸:
        #   - ì¶”ì„¸ì˜ ë°©í–¥ê³¼ ê°•ë„ë¥¼ ë™ì‹œì— íŒŒì•…í•˜ëŠ” ì§€í‘œ
        #   - MACDê°€ ì‹œê·¸ë„ì„ ìƒí–¥ ëŒíŒŒí•˜ë©´ ë§¤ìˆ˜ ì‹ í˜¸
        #   - MACDê°€ ì‹œê·¸ë„ì„ í•˜í–¥ ëŒíŒŒí•˜ë©´ ë§¤ë„ ì‹ í˜¸
        #   - íˆìŠ¤í† ê·¸ë¨ì´ 0ì„ ì„ ê¸°ì¤€ìœ¼ë¡œ ë°©í–¥ ì „í™˜ ì‹œ ì¶”ì„¸ ë³€í™” ê°ì§€
        #
        # ê³„ì‚° ë°©ë²•:
        #   1. MACD ë¼ì¸ = 12ì¼ EMA - 26ì¼ EMA
        #      (ë‹¨ê¸° ì¶”ì„¸ - ì¥ê¸° ì¶”ì„¸ = ì¶”ì„¸ì˜ ì°¨ì´)
        #   2. ì‹œê·¸ë„ ë¼ì¸ = MACDì˜ 9ì¼ EMA (MACDë¥¼ ë¶€ë“œëŸ½ê²Œ)
        #   3. íˆìŠ¤í† ê·¸ë¨ = MACD - ì‹œê·¸ë„ (ì‹ í˜¸ì˜ ê°•ë„)
        #
        # ì™œ ì´ ê¸°ê°„(12, 26, 9)ì„ ì‚¬ìš©í•˜ë‚˜?
        #   - ì œëŸ´ë“œ ì•„í ì´ ê°œë°œí•œ ì›ë˜ ì„¤ì •ê°’
        #   - í•œ ë‹¬ ì˜ì—…ì¼(ì•½ 26ì¼)ê³¼ 2ì£¼(ì•½ 12ì¼) ê¸°ì¤€
        #   - ëŒ€ë¶€ë¶„ì˜ íŠ¸ë ˆì´ë”ê°€ ì´ ê°’ì„ ì‚¬ìš©í•˜ë¯€ë¡œ ìê¸°ì‹¤í˜„ì  ì˜ˆì–¸ íš¨ê³¼
        # ====================================================================
        fast_ema = self.calculate_ema(data, fast_period)  # 12ì¼ EMA
        slow_ema = self.calculate_ema(data, slow_period)  # 26ì¼ EMA

        macd_line = fast_ema - slow_ema  # MACD = ë¹ ë¥¸ EMA - ëŠë¦° EMA
        signal_line = self.calculate_ema(macd_line, signal_period)  # ì‹œê·¸ë„ = MACDì˜ EMA
        histogram = macd_line - signal_line  # íˆìŠ¤í† ê·¸ë¨ = MACD - ì‹œê·¸ë„

        return {
            'macd': macd_line,
            'signal': signal_line,
            'histogram': histogram
        }

    def calculate_stochastic(
        self,
        high: pd.Series,
        low: pd.Series,
        close: pd.Series,
        k_period: int = 14,
        d_period: int = 3
    ) -> Dict[str, pd.Series]:
        """
        ìŠ¤í† ìºìŠ¤í‹± ì§€í‘œ ê³„ì‚°

        Args:
            high: ê³ ê°€ ë°ì´í„° (Series)
            low: ì €ê°€ ë°ì´í„° (Series)
            close: ì¢…ê°€ ë°ì´í„° (Series)
            k_period: %K ê¸°ê°„ (ê¸°ë³¸: 14)
            d_period: %D ê¸°ê°„ (ê¸°ë³¸: 3)

        Returns:
            {'%K': %K ë¼ì¸, '%D': %D ë¼ì¸}
        """
        # ====================================================================
        # [í•™ìŠµ í¬ì¸íŠ¸] ìŠ¤í† ìºìŠ¤í‹± (Stochastic Oscillator)
        # ====================================================================
        # íˆ¬ì ì˜ë¯¸:
        #   - í˜„ì¬ ê°€ê²©ì´ ìµœê·¼ ê°€ê²© ë²”ìœ„ì—ì„œ ì–´ë””ì— ìœ„ì¹˜í•˜ëŠ”ì§€ ì¸¡ì • (0~100%)
        #   - 0ì— ê°€ê¹Œì›€ = ìµœì €ê°€ ê·¼ì²˜ (ê³¼ë§¤ë„ â†’ ë°˜ë“± ê°€ëŠ¥ì„±)
        #   - 100ì— ê°€ê¹Œì›€ = ìµœê³ ê°€ ê·¼ì²˜ (ê³¼ë§¤ìˆ˜ â†’ í•˜ë½ ê°€ëŠ¥ì„±)
        #
        # ë§¤ë§¤ ì‹ í˜¸:
        #   - %Kê°€ 20 ì´í•˜ì—ì„œ %Dë¥¼ ìƒí–¥ ëŒíŒŒ â†’ ë§¤ìˆ˜ ì‹ í˜¸
        #   - %Kê°€ 80 ì´ìƒì—ì„œ %Dë¥¼ í•˜í–¥ ëŒíŒŒ â†’ ë§¤ë„ ì‹ í˜¸
        #
        # ê³„ì‚° ë°©ë²•:
        #   %K = 100 Ã— (ì¢…ê°€ - ìµœì €ê°€) / (ìµœê³ ê°€ - ìµœì €ê°€)
        #   %D = %Kì˜ 3ì¼ ì´ë™í‰ê·  (ì‹ í˜¸ì„ )
        #
        # ì˜ˆì‹œ:
        #   14ì¼ ìµœê³ ê°€: 110ì›, ìµœì €ê°€: 90ì›, í˜„ì¬ ì¢…ê°€: 105ì›
        #   %K = 100 Ã— (105-90) / (110-90) = 75%
        #   â†’ ìµœê·¼ ë²”ìœ„ì—ì„œ ìƒìœ„ 75% ìœ„ì¹˜
        # ====================================================================
        # %K ê³„ì‚°: í˜„ì¬ ì¢…ê°€ê°€ ìµœê·¼ ë²”ìœ„ì—ì„œ ì–´ë””ì— ìˆëŠ”ì§€
        lowest_low = low.rolling(window=k_period).min()  # 14ì¼ ìµœì €ê°€
        highest_high = high.rolling(window=k_period).max()  # 14ì¼ ìµœê³ ê°€

        k_percent = 100 * (close - lowest_low) / (highest_high - lowest_low)

        # %D ê³„ì‚° (Kì˜ ì´ë™í‰ê· ) - ì‹ í˜¸ì„  ì—­í• 
        d_percent = k_percent.rolling(window=d_period).mean()

        return {
            '%K': k_percent,
            '%D': d_percent
        }

    def calculate_obv(self, close: pd.Series, volume: pd.Series) -> pd.Series:
        """
        OBV (On-Balance Volume) ì§€í‘œ ê³„ì‚°

        Args:
            close: ì¢…ê°€ ë°ì´í„° (Series)
            volume: ê±°ë˜ëŸ‰ ë°ì´í„° (Series)

        Returns:
            OBV ê°’ (Series)
        """
        # ====================================================================
        # [í•™ìŠµ í¬ì¸íŠ¸] OBV (On-Balance Volume, ê±°ë˜ëŸ‰ ê· í˜• ì§€í‘œ)
        # ====================================================================
        # íˆ¬ì ì˜ë¯¸:
        #   - ê±°ë˜ëŸ‰ê³¼ ê°€ê²© ë³€í™”ë¥¼ ê²°í•©í•˜ì—¬ ë§¤ìˆ˜/ë§¤ë„ ì••ë ¥ì„ ì¸¡ì •
        #   - "ê±°ë˜ëŸ‰ì´ ê°€ê²©ì— ì„ í–‰í•œë‹¤"ëŠ” ì›ë¦¬ ê¸°ë°˜
        #   - OBV ìƒìŠ¹ + ê°€ê²© íš¡ë³´ â†’ ê³§ ìƒìŠ¹í•  ê°€ëŠ¥ì„± (ìˆ¨ì€ ë§¤ìˆ˜ì„¸)
        #   - OBV í•˜ë½ + ê°€ê²© íš¡ë³´ â†’ ê³§ í•˜ë½í•  ê°€ëŠ¥ì„± (ìˆ¨ì€ ë§¤ë„ì„¸)
        #
        # ê³„ì‚° ë°©ë²•:
        #   - ì¢…ê°€ ìƒìŠ¹ì¼: OBV += ë‹¹ì¼ ê±°ë˜ëŸ‰ (ë§¤ìˆ˜ ìš°ìœ„)
        #   - ì¢…ê°€ í•˜ë½ì¼: OBV -= ë‹¹ì¼ ê±°ë˜ëŸ‰ (ë§¤ë„ ìš°ìœ„)
        #   - ì¢…ê°€ ë³€ë™ì—†ìŒ: OBV ìœ ì§€
        #
        # ì˜ˆì‹œ:
        #   Day1: ì¢…ê°€ 100, ê±°ë˜ëŸ‰ 1000 â†’ OBV = 1000
        #   Day2: ì¢…ê°€ 105, ê±°ë˜ëŸ‰ 1500 â†’ OBV = 1000 + 1500 = 2500 (ìƒìŠ¹)
        #   Day3: ì¢…ê°€ 103, ê±°ë˜ëŸ‰ 800 â†’ OBV = 2500 - 800 = 1700 (í•˜ë½)
        # ====================================================================
        obv = pd.Series(index=close.index, dtype=float)
        obv.iloc[0] = volume.iloc[0]  # ì²«ë‚  OBV = ì²«ë‚  ê±°ë˜ëŸ‰

        for i in range(1, len(close)):
            if close.iloc[i] > close.iloc[i-1]:  # ì¢…ê°€ ìƒìŠ¹
                obv.iloc[i] = obv.iloc[i-1] + volume.iloc[i]  # ê±°ë˜ëŸ‰ ë”í•¨
            elif close.iloc[i] < close.iloc[i-1]:  # ì¢…ê°€ í•˜ë½
                obv.iloc[i] = obv.iloc[i-1] - volume.iloc[i]  # ê±°ë˜ëŸ‰ ëºŒ
            else:  # ì¢…ê°€ ë³€ë™ ì—†ìŒ
                obv.iloc[i] = obv.iloc[i-1]  # ìœ ì§€

        return obv

    def calculate_volatility_breakout(
        self,
        open_price: float,
        prev_high: float,
        prev_low: float,
        k_value: float = 0.5
    ) -> float:
        """
        ë³€ë™ì„± ëŒíŒŒ ì§€í‘œ ê³„ì‚° (Larry Williamsì˜ ë³€ë™ì„± ëŒíŒŒ ì „ëµ)

        ë§¤ìˆ˜ ê¸°ì¤€ê°€ = ë‹¹ì¼ ì‹œê°€ + (ì „ì¼ ê³ ê°€ - ì „ì¼ ì €ê°€) Ã— K

        Args:
            open_price: ë‹¹ì¼ ì‹œê°€
            prev_high: ì „ì¼ ê³ ê°€
            prev_low: ì „ì¼ ì €ê°€
            k_value: K ê°’ (ê¸°ë³¸: 0.5)

        Returns:
            ë³€ë™ì„± ëŒíŒŒ ê¸°ì¤€ê°€
        """
        # ====================================================================
        # [í•™ìŠµ í¬ì¸íŠ¸] ë³€ë™ì„± ëŒíŒŒ ì „ëµ (Larry Williams)
        # ====================================================================
        # íˆ¬ì ì˜ë¯¸:
        #   - ìœ ëª… íŠ¸ë ˆì´ë” ë˜ë¦¬ ìœŒë¦¬ì—„ìŠ¤ê°€ ê°œë°œí•œ ë‹¨ê¸° ë§¤ë§¤ ì „ëµ
        #   - ì „ì¼ ë³€ë™í­ì˜ ì¼ì • ë¹„ìœ¨(K)ë§Œí¼ ìƒìŠ¹í•˜ë©´ ë§¤ìˆ˜
        #   - "ì–´ì œ ë³€ë™í­ì´ ì»¸ìœ¼ë©´ ì˜¤ëŠ˜ë„ í¬ê²Œ ì›€ì§ì¼ ê°€ëŠ¥ì„±ì´ ìˆë‹¤"
        #
        # ê³µì‹:
        #   ë§¤ìˆ˜ ê¸°ì¤€ê°€ = ë‹¹ì¼ ì‹œê°€ + (ì „ì¼ ê³ ê°€ - ì „ì¼ ì €ê°€) Ã— K
        #   Kê°’ì€ ë³´í†µ 0.4~0.6 ì‚¬ìš© (ê¸°ë³¸ê°’ 0.5)
        #
        # ì˜ˆì‹œ:
        #   ì–´ì œ ê³ ê°€: 110ì›, ì €ê°€: 100ì› â†’ ë³€ë™í­ = 10ì›
        #   ì˜¤ëŠ˜ ì‹œê°€: 105ì›, K = 0.5
        #   ë§¤ìˆ˜ ê¸°ì¤€ê°€ = 105 + (10 Ã— 0.5) = 110ì›
        #   â†’ ì˜¤ëŠ˜ ì£¼ê°€ê°€ 110ì›ì„ ëŒíŒŒí•˜ë©´ ë§¤ìˆ˜ ì‹ í˜¸
        #
        # ì¥ì : ë‹¨ìˆœí•˜ê³  ëª…í™•í•œ ê·œì¹™
        # ë‹¨ì : íš¡ë³´ì¥ì—ì„œëŠ” ì†ì‹¤ ê°€ëŠ¥, Kê°’ ìµœì í™” í•„ìš”
        # ====================================================================
        prev_range = prev_high - prev_low  # ì „ì¼ ë³€ë™í­
        breakout_price = open_price + (prev_range * k_value)  # ëŒíŒŒ ê¸°ì¤€ê°€

        return breakout_price

    def calculate_rsi(self, data: pd.Series, period: int = 14) -> pd.Series:
        """
        RSI (Relative Strength Index) ê³„ì‚°

        Args:
            data: ê°€ê²© ë°ì´í„° (Series)
            period: RSI ê¸°ê°„ (ê¸°ë³¸: 14)

        Returns:
            RSI ê°’ (Series)
        """
        # ====================================================================
        # [í•™ìŠµ í¬ì¸íŠ¸] RSI (Relative Strength Index, ìƒëŒ€ê°•ë„ì§€ìˆ˜)
        # ====================================================================
        # íˆ¬ì ì˜ë¯¸:
        #   - ê°€ê²© ìƒìŠ¹/í•˜ë½ì˜ ê°•ë„ë¥¼ 0~100 ë²”ìœ„ë¡œ í‘œí˜„
        #   - 70 ì´ìƒ: ê³¼ë§¤ìˆ˜ êµ¬ê°„ (ê°€ê²©ì´ ë„ˆë¬´ ì˜¬ëë‹¤ â†’ ì¡°ì • ê°€ëŠ¥ì„±)
        #   - 30 ì´í•˜: ê³¼ë§¤ë„ êµ¬ê°„ (ê°€ê²©ì´ ë„ˆë¬´ ë‚´ë ¸ë‹¤ â†’ ë°˜ë“± ê°€ëŠ¥ì„±)
        #
        # ë§¤ë§¤ ì‹ í˜¸:
        #   - RSI 30 ì´í•˜ì—ì„œ ë°˜ë“± ì‹œ ë§¤ìˆ˜
        #   - RSI 70 ì´ìƒì—ì„œ í•˜ë½ ì‹œ ë§¤ë„
        #   - ë‹¤ì´ë²„ì „ìŠ¤: ê°€ê²©ê³¼ RSIê°€ ë°˜ëŒ€ë¡œ ì›€ì§ì´ë©´ ì¶”ì„¸ ì „í™˜ ì‹ í˜¸
        #
        # ê³„ì‚° ë°©ë²•:
        #   1. ê°€ê²© ë³€í™”ëŸ‰ ê³„ì‚° (diff)
        #   2. ìƒìŠ¹ë¶„ê³¼ í•˜ë½ë¶„ ë¶„ë¦¬
        #   3. í‰ê·  ìƒìŠ¹í­ / í‰ê·  í•˜ë½í­ = RS
        #   4. RSI = 100 - (100 / (1 + RS))
        # ====================================================================
        delta = data.diff()  # ê°€ê²© ë³€í™”ëŸ‰ (ì˜¤ëŠ˜ - ì–´ì œ)

        # ìƒìŠ¹ë¶„ê³¼ í•˜ë½ë¶„ ë¶„ë¦¬
        gain = delta.where(delta > 0, 0)  # ìƒìŠ¹ì¼: ë³€í™”ëŸ‰, í•˜ë½ì¼: 0
        loss = -delta.where(delta < 0, 0)  # í•˜ë½ì¼: ë³€í™”ëŸ‰(ì–‘ìˆ˜ë¡œ), ìƒìŠ¹ì¼: 0

        # í‰ê·  ê³„ì‚°
        avg_gain = gain.rolling(window=period).mean()  # í‰ê·  ìƒìŠ¹í­
        avg_loss = loss.rolling(window=period).mean()  # í‰ê·  í•˜ë½í­

        # RSI ê³„ì‚°
        rs = avg_gain / avg_loss  # Relative Strength
        rsi = 100 - (100 / (1 + rs))  # RSI ê³µì‹

        return rsi

    def detect_golden_cross(
        self,
        short_ma: pd.Series,
        long_ma: pd.Series
    ) -> pd.Series:
        """
        ê³¨ë“ í¬ë¡œìŠ¤ ê°ì§€

        Args:
            short_ma: ë‹¨ê¸° ì´ë™í‰ê· ì„ 
            long_ma: ì¥ê¸° ì´ë™í‰ê· ì„ 

        Returns:
            ê³¨ë“ í¬ë¡œìŠ¤ ë°œìƒ ì—¬ë¶€ (True/False Series)
        """
        # ====================================================================
        # [í•™ìŠµ í¬ì¸íŠ¸] ê³¨ë“ í¬ë¡œìŠ¤ (Golden Cross)
        # ====================================================================
        # íˆ¬ì ì˜ë¯¸:
        #   - ë‹¨ê¸° ì´ë™í‰ê· ì„ ì´ ì¥ê¸° ì´ë™í‰ê· ì„ ì„ ì•„ë˜ì—ì„œ ìœ„ë¡œ ëŒíŒŒ
        #   - ìƒìŠ¹ ì¶”ì„¸ ì‹œì‘ ì‹ í˜¸ë¡œ í•´ì„ (ë§¤ìˆ˜ ì‹ í˜¸)
        #   - ë°˜ëŒ€ë¡œ ìœ„ì—ì„œ ì•„ë˜ë¡œ ëŒíŒŒí•˜ë©´ "ë°ë“œí¬ë¡œìŠ¤" (ë§¤ë„ ì‹ í˜¸)
        #
        # ê¸°ìˆ ì  êµ¬í˜„:
        #   .shift(1): ë°ì´í„°ë¥¼ 1ì¹¸ ë’¤ë¡œ ë°€ì–´ì„œ "ì–´ì œ" ê°’ì„ ì–»ìŒ
        #   prev_below: ì–´ì œ ë‹¨ê¸° MA < ì¥ê¸° MA (ë‹¨ê¸°ê°€ ì•„ë˜ì— ìˆì—ˆìŒ)
        #   curr_above: ì˜¤ëŠ˜ ë‹¨ê¸° MA > ì¥ê¸° MA (ë‹¨ê¸°ê°€ ìœ„ë¡œ ì˜¬ë¼ì˜´)
        #   & (AND ì—°ì‚°): ë‘˜ ë‹¤ Trueì¼ ë•Œë§Œ ê³¨ë“ í¬ë¡œìŠ¤
        #
        # ì˜ˆì‹œ:
        #   ì–´ì œ: 5ì¼ MA = 99, 20ì¼ MA = 100 â†’ prev_below = True
        #   ì˜¤ëŠ˜: 5ì¼ MA = 101, 20ì¼ MA = 100 â†’ curr_above = True
        #   â†’ ê³¨ë“ í¬ë¡œìŠ¤ ë°œìƒ!
        # ====================================================================
        # ì´ì „ ì‹œì ì—ì„œëŠ” short_maê°€ long_ma ì•„ë˜ì— ìˆì—ˆê³ 
        prev_below = short_ma.shift(1) <= long_ma.shift(1)
        # í˜„ì¬ ì‹œì ì—ì„œëŠ” short_maê°€ long_ma ìœ„ë¡œ ì˜¬ë¼ê°„ ê²½ìš°
        curr_above = short_ma > long_ma

        # ë‘ ì¡°ê±´ì´ ëª¨ë‘ ì¶©ì¡±ë˜ë©´ ê³¨ë“ í¬ë¡œìŠ¤
        golden_cross = prev_below & curr_above

        return golden_cross

    def detect_dead_cross(
        self,
        short_ma: pd.Series,
        long_ma: pd.Series
    ) -> pd.Series:
        """
        ë°ë“œí¬ë¡œìŠ¤ ê°ì§€

        Args:
            short_ma: ë‹¨ê¸° ì´ë™í‰ê· ì„ 
            long_ma: ì¥ê¸° ì´ë™í‰ê· ì„ 

        Returns:
            ë°ë“œí¬ë¡œìŠ¤ ë°œìƒ ì—¬ë¶€ (True/False Series)
        """
        # ì´ì „ ì‹œì ì—ì„œëŠ” short_maê°€ long_ma ìœ„ì— ìˆì—ˆê³ 
        # í˜„ì¬ ì‹œì ì—ì„œëŠ” short_maê°€ long_ma ì•„ë˜ë¡œ ë‚´ë ¤ê°„ ê²½ìš°
        prev_above = short_ma.shift(1) >= long_ma.shift(1)
        curr_below = short_ma < long_ma

        dead_cross = prev_above & curr_below

        return dead_cross

    def check_price_above_ma(
        self,
        price: float,
        ma_values: pd.Series
    ) -> bool:
        """
        í˜„ì¬ ê°€ê²©ì´ ì´ë™í‰ê· ì„  ìœ„ì— ìˆëŠ”ì§€ í™•ì¸

        Args:
            price: í˜„ì¬ ê°€ê²©
            ma_values: ì´ë™í‰ê· ì„  ê°’

        Returns:
            ì´ë™í‰ê· ì„  ìœ„ì— ìˆìœ¼ë©´ True
        """
        if len(ma_values) == 0:
            return False

        current_ma = ma_values.iloc[-1]

        if pd.isna(current_ma):
            return False

        return price > current_ma

    def calculate_bollinger_bands(
        self,
        data: pd.Series,
        period: int = 20,
        num_std: float = 2.0
    ) -> Dict[str, pd.Series]:
        """
        ë³¼ë¦°ì € ë°´ë“œ ê³„ì‚°

        Args:
            data: ê°€ê²© ë°ì´í„° (Series)
            period: ì´ë™í‰ê·  ê¸°ê°„ (ê¸°ë³¸: 20)
            num_std: í‘œì¤€í¸ì°¨ ë°°ìˆ˜ (ê¸°ë³¸: 2.0)

        Returns:
            {'upper': ìƒë‹¨ ë°´ë“œ, 'middle': ì¤‘ê°„ ë°´ë“œ, 'lower': í•˜ë‹¨ ë°´ë“œ}
        """
        middle_band = self.calculate_ma(data, period)
        std = data.rolling(window=period).std()

        upper_band = middle_band + (std * num_std)
        lower_band = middle_band - (std * num_std)

        return {
            'upper': upper_band,
            'middle': middle_band,
            'lower': lower_band
        }


# ì‚¬ìš© ì˜ˆì‹œ
if __name__ == "__main__":
    # í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±
    dates = pd.date_range('2024-01-01', periods=100, freq='D')
    test_data = pd.DataFrame({
        'close': np.random.randn(100).cumsum() + 100,
        'high': np.random.randn(100).cumsum() + 105,
        'low': np.random.randn(100).cumsum() + 95,
        'volume': np.random.randint(1000000, 10000000, 100)
    }, index=dates)

    # ì§€í‘œ ê³„ì‚°
    indicators = TechnicalIndicators()

    # ì´ë™í‰ê· ì„ 
    ma20 = indicators.calculate_ma(test_data['close'], 20)
    print("MA(20):", ma20.tail())

    # MACD
    macd_result = indicators.calculate_macd(test_data['close'])
    print("\nMACD:", macd_result['macd'].tail())

    # ìŠ¤í† ìºìŠ¤í‹±
    stoch_result = indicators.calculate_stochastic(
        test_data['high'],
        test_data['low'],
        test_data['close']
    )
    print("\nStochastic %K:", stoch_result['%K'].tail())

    # OBV
    obv = indicators.calculate_obv(test_data['close'], test_data['volume'])
    print("\nOBV:", obv.tail())
